## Vola Protocol

**Vola Protocol converts LSDs into two derivatives: 1. USD.hype: a stablecoin with zero volatility and 2. HYPE.v: a leveraged long token with higher volatility. USD.hype can turn the HYPE-denominated yields for HIP-3 LSDs into USD-denominated yields, even more concentrated. HYPE.v can let users leverage long HYPE without ONE-TIME-LIQUIDATION-RISK and ongoing funding expenditure.**

Vola Protocol is a decentralized system that converts Liquid Staking Derivatives (LSDs) into two new derivative tokens through a unique mechanism designed for yield concentration and risk management. The protocol elegantly solves two different, significant problems for two distinct user groups simultaneously, creating a symbiotic relationship between conservative DeFi farmers and risk-seeking leveraged traders.

### Core Innovation

**For DeFi Farmers**: Addresses the critical lack of high-yield, USD-denominated opportunities by concentrating LSD yields into a stablecoin, providing stable, high returns with principal protection.

**For Leveraged Traders**: Creates a fundamentally better way to gain leveraged exposure by removing high funding costs and liquidation risks, providing a more resilient and capital-efficient trading instrument.

### How It Works

1. **Core Function**: The protocol takes LSDs as collateral and mints two new assets:
   - **USD.hype (fToken)**: A stablecoin designed for zero volatility
   - **HYPE.v (xToken)**: A leveraged token designed for higher volatility and long exposure to the underlying LSD

2. **Yield Concentration**: The system is engineered to provide high, stablecoin-denominated yields to DeFi farmers. Most of the yield generated by the underlying LSD collateral is aggregated into "rebalance pools". The USD.hype staked in these pools receives nearly all of this aggregated income, which concentrates the returns and results in a substantially higher APR in stablecoins (e.g., 12.5% APR) than the LSD could provide on its own (e.g., 2.5% APR).

3. **Leverage without Liquidation**: For leveraged traders, HYPE.v offers leveraged long exposure to LSDs without the typical risks. The protocol charges no permanent funding fees and, most importantly, has no one-time liquidation mechanism. This protects traders from being forced out of their positions by brief, volatile price spikes. The position remains intact unless the underlying LSD's value drops to zero.

4. **Rebalancing for Stability**: The stability of USD.hype is maintained by a multi-layered over-collateralization buffer. If the price of the collateral LSD falls and the system's collateral ratio drops below a set threshold (e.g., 130%), a rebalancing mechanism is automatically triggered. During this state, the protocol uses its reserves to redeem USD.hype for the underlying LSD, raising the collateral ratio back to a safe level and ensuring the stablecoin remains fully backed.

5. **Multi-Chain Architecture**: The system is designed with a multi-chain architecture in mind, capable of integrating various LSDs across different chains like BNB Chain, HyperEVM, and Solana by creating distinct markets for each.

### System Components

The protocol includes:
- A Treasury that holds collateral and enforces risk rules
- A Market that mints/redeems fToken and xToken against the Treasury
- A wrapped stable aggregator token, VolaUSD, that can hold a basket of fTokens across markets and integrates with Rebalance Pools
- Rebalance Pools and a Registry to manage fToken flow and rewards
- A Reserve Pool to fund on-chain incentives/bonuses
- Oracles and math libraries for pricing and accounting
- A voting-escrowed governance suite with gauges and distributors

This README gives a high-level map for product managers and integrators, with pointers to key contracts and typical flows.


## Repository layout

- `vola/v2/`
  - `TreasuryV2.sol`: Collateral accounting, pricing, limits, stability mode
  - `MarketV2.sol`: User-facing mint/redeem logic for fToken/xToken, fees, limits
  - `FractionalTokenV2.sol`: ERC20 fToken, `nav()` under stress uses Treasury state
  - `LeveragedTokenV2.sol`: ERC20 xToken, transfer cooling-off and `nav()`
  - `HypeUSD.sol` (contract `VolaUSD`): Wrapped stable aggregator and router for fToken flows and Rebalance Pools
- `vola/rebalance-pool/`
  - `RebalancePoolRegistry.sol`: Registry of pools, aggregate supply view
  - Shareable/Boostable pool implementations and helpers
- `vola/reserve-pool/`
  - `ReservePoolV2.sol`: Bonus funding with per-token ratios, callable by markets
- `vola/rebalancer/`
  - Rebalancing helpers for flows involving bonus tokens and VolaUSD
- `vola/oracle/`
  - `HypeOracle.sol`: Example price oracle using precompiles, conforms to `IVolaPriceOracleV2`
- `vola/rate-provider/`
  - Rate provider adapters for external integrations (e.g., ERC4626, wstHYPE)
- `vola/math/`
  - Deterministic math utilities for pricing, fees, and stability calculations
- `vola/VolaVault.sol`
  - Simple vault coordinating two assets (e.g., vola and LP) with a fixed ratio
- `voting-escrow/`
  - `VotingEscrow.vy`: ve-style time-weighted voting power
  - `VotingEscrowBoost.sol`, `VotingEscrowProxy.sol`: Boosting and proxying
  - `FeeDistributor.vy`, `TokenMinter.vy`: Fee flow and token emissions
  - `gauges/`: Gauges for liquidity and fundraising
- `External.sol`
  - Imports of OZ proxy primitives for upgradeability patterns


## Core concepts

- **Collateral ratio (CR)**: Treasury tracks base-token collateral and adjusts mint/redeem boundaries; a stability mode can limit operations when CR is stressed.
- **fToken NAV**: In normal state, fToken targets 1.0 NAV; under collateralization, fToken `nav()` reflects pro-rata base claim.
- **xToken NAV**: Residual claim; becomes 0 in under-collateralization.
- **VolaUSD**: A wrapper/aggregator that holds fTokens across multiple supported markets. It can mint by routing through a Market, wrap existing fTokens, and deposit into Rebalance Pools in a single transaction.
- **Rebalance Pools**: Shared pools for fTokens that can route yield/incentives; a Registry surfaces the set of active pools and supply. These pools concentrate yields from multiple LSD markets into USD.hype holders.
- **Reserve Pool**: A treasury for incentive/bonus tokens with configurable per-token payout ratios, drawn by Markets during flows.
- **Governance**: ve-style locking and gauges direct emissions or incentives; fees can be distributed pro-rata via the Fee Distributor.
- **Yield Concentration**: The core innovation that aggregates yields from leveraged positions into stablecoin holders, creating higher APRs than individual LSDs can provide.


## Key contracts and roles

### TreasuryV2
- Purpose: Canonical state machine for a base market; owns the collateral and mints/burns fToken/xToken.
- Selected views:
  - `baseToken()`, `fToken()`, `xToken()`
  - `collateralRatio()`: uint256 1e18
  - `isUnderCollateral()`: bool
  - `totalBaseToken()`: uint256
  - `currentBaseTokenPrice()`: uint256 1e18 (via oracle)
  - `maxMintableFToken(uint256 newCR)`/`maxMintableXToken(uint256 newCR)`
  - `maxRedeemableFToken(uint256 newCR)`/`maxRedeemableXToken(uint256 newCR)`
- Selected roles (AccessControl):
  - `DEFAULT_ADMIN_ROLE`: parameter management
  - `Vola_MARKET_ROLE`: authorized market
  - `SETTLE_WHITELIST_ROLE`, `PROTOCOL_INITIALIZER_ROLE`: specialized flows

### MarketV2
- Purpose: User bridge for minting/redeeming fToken and xToken against the Treasury; fees and stability mode gating.
- Selected views:
  - `mintPaused()`, `redeemPaused()`
  - `stabilityRatio()`: enter stability mode threshold (1e18)
  - `fTokenMintFeeRatio()`, `xTokenMintFeeRatio()`, `fTokenRedeemFeeRatio()`, `xTokenRedeemFeeRatio()`
  - Quoters: `getMintFToken(uint256 baseIn)`, `getMintXToken(uint256 baseIn)` return preview amounts, caps, and fees
- Selected state:
  - Immutable: `treasury`, `baseToken`, `fToken`, `xToken`
  - Mutable: `platform`, `reservePool`, `registry`, `volaUSD`
- Role: `EMERGENCY_DAO_ROLE` for circuit breakers

### FractionalTokenV2 (fToken) - USD.hype
- ERC20 with `ERC20Permit`.
- `nav()`: if under collateralization, computes pro-rata claim to Treasury base; else 1e18.
- Mint/burn restricted to `TreasuryV2`.
- **Key Innovation**: Provides zero-volatility exposure to underlying LSD with concentrated yield benefits.

### LeveragedTokenV2 (xToken) - HYPE.v
- ERC20 with `ERC20Permit` and transfer cooling-off enforcement.
- `nav()`: zero in under-collateralization; else residual claim.
- Roles: `DEFAULT_ADMIN_ROLE` (params), `THIRD_PARTY_MINTER_ROLE` (CEX/aggregator flows).
- **Key Innovation**: Provides leveraged exposure without liquidation risk or ongoing funding costs.

### VolaUSD (file: `vola/v2/HypeUSD.sol`)
- ERC20 with AccessControl that aggregates fToken exposures across supported markets and integrates with Rebalance Pools.
- Market management:
  - `getMarkets()`: address[] base tokens
  - `getRebalancePools()`: address[] pools
  - `nav()`: basket NAV
  - `isUnderCollateral()`: true if any underlying market is under-collateralized
- Flows:
  - `wrap(baseToken, amount, receiver)`: wrap fToken into VolaUSD shares
  - `wrapFrom(pool, amount, receiver)`: withdraw fToken from pool and wrap
  - `mint(baseToken, amountIn, receiver, minOut)`: route base->fToken via Market->shares
  - `earn(pool, amount, receiver)`: burn shares and deposit fToken into pool
  - `mintAndEarn(pool, amountIn, receiver, minOut)`: one-step mint to pool
  - `redeem(...)`: unwrap flows back to fToken/base as supported
- Whitelist for allowance bypass: admin can `flipApproveWhiteList(spender)` for integrators.

### Rebalance Pools and Registry
- `RebalancePoolRegistry.sol` tracks authorized pools and aggregates `totalSupply()` across them.
- Pool implementations under `vola/rebalance-pool/` can be shareable, boostable, or attach to external gauges.
- Splitters and wrappers help route rewards and handle reward tokens.
- **Key Innovation**: Concentrates yields from leveraged positions into stablecoin holders, creating higher APRs.

### ReservePoolV2
- Holds incentive tokens/ETH for bonus payouts.
- Admin: `updateBonusRatio(token, ratio)` with 0â€“1e18 caps.
- Market-only:
  - `requestBonus(token, recipient, originalAmount)` returns and transfers computed bonus, emits `RequestBonus`.
  - `getRequestBonus(token, originalAmount)` is a view to quote the bonus.

### Oracles
- `HypeOracle.sol`: Example oracle that reads from chain precompiles and scales to 1e18; implements `IVolaPriceOracleV2` returning (isValid, twap, min, max).
- Treasuries consume oracle price to value base collateral.

### Governance suite (voting-escrow and gauges)
- `VotingEscrow.vy`: Lock governance token for ve power (max 4 years), linear decay.
- `FeeDistributor.vy`: Distribute fees over time to ve holders.
- `VotingEscrowBoost.sol` and `gauges/*`: Boosted voting and per-pool gauges for directing emissions/liquidity incentives.
- `SmartWalletWhitelist.sol`: Optional safety for smart contract depositors.


## Typical flows

1) **Mint fToken or xToken against a base token**
- User queries `MarketV2.getMintFToken(baseIn)` or `getMintXToken(baseIn)` to preview limits and output.
- User approves base token to Market and calls `mint` function exposed by Market (not shown here) to receive fToken/xToken minted by Treasury.
- Market may pull bonus incentives from `ReservePoolV2` depending on configuration.

2) **Wrap into VolaUSD and earn concentrated yields**
- If holding fToken: call `VolaUSD.wrap(baseToken, amount, receiver)` to receive VolaUSD shares.
- To supply fToken into a pool in one step: `VolaUSD.mintAndEarn(pool, amountInBase, receiver, minOut)`.
- To move shares into a pool: `VolaUSD.earn(pool, amountShares, receiver)` burns shares and deposits equivalent fToken into `pool`.
- **Yield Concentration**: fToken holders in rebalance pools receive concentrated yields from leveraged positions.

3) **Leveraged trading without liquidation risk**
- Mint HYPE.v tokens for leveraged long exposure to HYPE LSDs.
- No ongoing funding costs or liquidation risk from price volatility.
- Position remains intact unless underlying LSD value drops to zero.

4) **Unwrap or redeem**
- `VolaUSD.redeem(baseToken, amountIn, receiver, minOut)` unwraps shares back to fToken and/or base (as supported by the underlying market configuration).

5) **Governance and rewards**
- Lock governance token in `VotingEscrow` to obtain ve power; vote for gauges.
- Claim protocol fees from `FeeDistributor` and rewards via relevant gauge contracts.


## Roles and permissions (non-exhaustive)
- Protocol administration uses OpenZeppelin AccessControl:
  - `DEFAULT_ADMIN_ROLE`: global admin on a given contract
  - `EMERGENCY_DAO_ROLE` (Market): pause-style controls
  - `Vola_MARKET_ROLE` (Treasury): authorized market caller
  - `SETTLE_WHITELIST_ROLE`, `PROTOCOL_INITIALIZER_ROLE` (Treasury): specialized ops
  - `MARKET_ROLE` (ReservePool): who can draw bonus funds (e.g., Markets)
  - `THIRD_PARTY_MINTER_ROLE` (xToken): allows minting without cooling-off restrictions on transfer


## Development and integration

- Languages
  - Solidity 0.8.20 (most of `vola/*`)
  - Solidity 0.7.6 (`vola/VolaVault.sol`, `External.sol`)
  - Vyper 0.3.x (`voting-escrow/*` core)

- Tooling
  - Contracts are standard OZ-upgradeable style. You can compile with Foundry (forge) or Hardhat/Vieme as long as you pin compilers to the versions above and set remappings for OpenZeppelin v4 packages used.
  - Oracles and external adapters may require chain-specific precompiles (see `HypeOracle.sol`).

- Testing
  - Recommended to simulate stress cases: stability mode entry/exit, under-collateralization, mint/redeem caps, fee deltas across ranges, and bonus pool exhaustion.


## Safety and risk notes
- **Under-collateralization**: If `TreasuryV2.isUnderCollateral()` becomes true, fToken `nav()` falls to pro-rata base claim and xToken `nav()` becomes 0; VolaUSD halts flows that require minting and will surface the state via `isUnderCollateral()`.
- **Stability mode**: `MarketV2.stabilityRatio()` gates mint/redeem operations; separate flags allow pausing fToken mint or xToken redeem during stress.
- **Oracle assumptions**: Ensure `IVolaPriceOracleV2` implementations are robust, with TWAPs and bounds.
- **Admin trust**: Administrator roles can update parameters and whitelists; production deployments should use timelocks and multi-sigs.
- **Liquidation protection**: HYPE.v tokens have no one-time liquidation mechanism, protecting traders from forced position closures due to price volatility.


## License

This repository is released under the MIT License. See SPDX headers in files.


## Acknowledgements

- Vote-escrow design and parts of the implementation are adapted from Curve Finance's `veCRV` architecture.
